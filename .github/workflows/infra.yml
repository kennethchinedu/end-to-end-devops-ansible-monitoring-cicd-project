name: Infra Pipeline

on:
   push:
     branches:
       - main
     paths:
       - 'ansible/**'
       - 'terraform/**'
       - '.github/workflows/**'
 
        
env:
   AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
   AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
   AWS_DEFAULT_REGION: 'us-east-1'
   
jobs:
  terraform:
#    if: ${{ github.event_name == 'push' && (github.event.commits.*.message | join(' ') =~ 'terraform' || github.event.head_commit.message =~ 'terraform') }}
    runs-on: ubuntu-latest
    environment: dev
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ env.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ env.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1 

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_wrapper: false
          
      - name: Terraform Init
        run:  terraform init
        

      - name: Terraform Apply
        run: terraform apply --auto-approve 
      - name: Set up Ansible
        run: sudo apt-get update && sudo apt-get install -y ansible 

      - name: install boto & aws collection
        run: |
          ansible-galaxy collection install cloud.terraform
          sudo apt-get install python3-pip -y && pip3 install boto boto3


      - name: Run server playbook
        run: |
          ansible-playbook -i ./ansible/servers.aws_ec2.yml  ./ansible/server_playbook.yml   -vvv
        working-directory: ansible
        
      - name: Run Monitoring Playbook
        run: ansible-playbook -i hosts monitoring_playbook.yml -vvv
        working-directory: ansible



